name: Local CI/CD with K3d

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: llmops-app
  IMAGE_TAG: latest
  DEPLOYMENT_FILE: deployment.yaml
  SERVICE_FILE: service.yaml
  DEPLOYMENT_NAME: gpt-huggingface
  CONTAINER_NAME: gptcontainer


# =====================================================
# 1️⃣ SETUP JOB
# =====================================================
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      python-cache: ${{ steps.cache-python.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8 pytest


# =====================================================
# 2️⃣ LINT JOB
# =====================================================
  lint:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8

      - name: Run Flake8
        run: flake8 . --count --statistics --exit-zero


# =====================================================
# 3️⃣ UNIT TEST JOB
# =====================================================
  test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:${GITHUB_WORKSPACE}"
          pytest tests/ --maxfail=1 --disable-warnings -q


# =====================================================
# 4️⃣ SECURITY SCAN JOB
# =====================================================
  scan:
    runs-on: ubuntu-latest
    needs: [ lint, test ]
    steps:
      - uses: actions/checkout@v4

      - name: Trivy Filesystem Scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/src \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            filesystem \
            --severity HIGH,CRITICAL \
            /src || true

      - name: Trivy Image Scan Placeholder
        run: echo "Will scan image after build"


# =====================================================
# 5️⃣ BUILD ➜ PUSH IMAGE JOB
# =====================================================
  build_publish:
    runs-on: ubuntu-latest
    needs: scan
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag for GHCR
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            ghcr.io/imbongzxc/llmops-app:${{ env.IMAGE_TAG }}

      - name: Push to GHCR
        run: |
          docker push ghcr.io/imbongzxc/llmops-app:${{ env.IMAGE_TAG }}

      - name: Scan Final Image
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $HOME/.cache/trivy:/root/.cache \
            aquasec/trivy:latest \
            image \
            --severity HIGH,CRITICAL \
            ghcr.io/imbongzxc/llmops-app:${{ env.IMAGE_TAG }} \
            || true


# =====================================================
# 6️⃣ DEPLOY TO LOCAL K3D JOB
# =====================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build_publish
    steps:
      - uses: actions/checkout@v4

      - name: Install K3d & Create Cluster
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d cluster create llmops --api-port 6550 -p "30007:30007@server:0" || echo "Cluster exists"

      - name: Pull image from GHCR
        run: |
          docker pull ghcr.io/imbongzxc/llmops-app:latest
      
      - name: Import image into k3d
        run: |
          k3d image import ghcr.io/imbongzxc/llmops-app:latest --cluster llmops

      - name: Deploy Manifests
        run: |
          kubectl apply -f ${{ env.DEPLOYMENT_FILE }}
          kubectl apply -f ${{ env.SERVICE_FILE }}
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
            ${{ env.CONTAINER_NAME }}=ghcr.io/imbongzxc/llmops-app:${{ env.IMAGE_TAG }} --record

      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=180s


# =====================================================
# 7️⃣ POST DEPLOY TEST JOB
# =====================================================
  post_deploy_test:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Show endpoint
        run: |
          echo "App available at http://localhost:30007"
